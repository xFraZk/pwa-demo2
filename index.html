<!DOCTYPE html>
<html lang="es">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PWA Demo - Hoho3D</title>

  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="icons/icon-512.png" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #fafafa;
      flex-direction: column;
    }
    h1 { font-size: 2rem; color: #111; }
    button {
      background: #000;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 10px;
    }
    button:active { transform: scale(0.98); }
    #token-display {
      font-size: 12px;
      word-break: break-all;
      max-width: 90vw;
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
    }

    /* --- NUEVOS ESTILOS PARA LOS MODALES --- */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      /* Ocultos por defecto */
      display: none; 
    }
    .modal {
      background: white;
      padding: 2rem 3rem;
      border-radius: 10px;
      text-align: center;
      color: #111;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal h2 { margin-top: 0; }
    /* (Opcional) Un spinner de carga */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* --- FIN DE NUEVOS ESTILOS --- */
  </style>
</head>
<body>
  <h1>üöÄ Hola desde tu PWA</h1>
  
  <button id="install-pwa-button" style="display: none;">‚¨áÔ∏è Instalar App</button>
  
  <button id="activar-notificaciones">üîî Activar Notificaciones</button>

  <div id="token-display" style="display: none;"></div>

  <div id="install-loader-overlay" class="overlay">
    <div class="modal">
      <h2>Instalando...</h2>
      <div class="loader"></div>
      <p>Por favor, espera un momento.</p>
    </div>
  </div>

  <div id="install-success-overlay" class="overlay">
    <div class="modal">
      <h2>¬°Tienda Instalada!</h2>
      <p>Ya pod√©s encontrar la app en tu pantalla de inicio.</p>
      <button id="close-success-modal">¬°Entendido!</button>
    </div>
  </div>


  <script type="module">
    // 1. IMPORTAR TODO...
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-messaging.js";

    // 2. CONFIGURACI√ìN DE FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyAsXGq7D0jlXKUywesedniS0L0dV_8nWkY",
      authDomain: "hoho3d-pwa.firebaseapp.com",
      projectId: "hoho3d-pwa",
      storageBucket: "hoho3d-pwa.firebasestorage.app",
      messagingSenderId: "950865642151",
      appId: "1:950865642151:web:a7749cf9651d706e5f5182"
    };

    // 3. TU VAPID KEY
    const VAPID_KEY = "BB_2CNl7dALAgMi3vsV_pq5FSXJjHETWplXsWbqtRwBw-GskC1BBsNEZEGIqsUPJcqOfnRWWiV-ZFzREjr6OgY8";

    // 4. INICIALIZAR FIREBASE Y MESSAGING
    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);

    // 5. FUNCI√ìN PARA OBTENER EL TOKEN (Sin cambios)
    async function obtenerYMostrarToken() {
      console.log('Pidiendo permiso para notificaciones...');
      try {
        const currentToken = await getToken(messaging, { vapID_KEY });
        if (currentToken) {
          console.log('üîë Token de registro de FCM:', currentToken);
          const tokenDiv = document.getElementById('token-display');
          tokenDiv.style.display = 'block';
          tokenDiv.innerHTML = `<b>Tu Token:</b> ${currentToken}`;
        } else {
          console.log('No se pudo obtener el token. Permiso no concedido.');
        }
      } catch (err) {
        console.error('Ocurri√≥ un error al obtener el token:', err);
      }
    }

    // 6. MANEJAR MENSAJES EN PRIMER PLANO (Sin cambios)
    onMessage(messaging, (payload) => {
      console.log('üì© Mensaje recibido en primer plano:', payload);
      alert(`Notificaci√≥n: ${payload.notification.title}`);
    });

    // 7. REGISTRAR EL SERVICE WORKER (Sin cambios)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then((registration) => console.log('‚úÖ Service Worker registrado (unificado)'))
        .catch(err => console.error('‚ùå Error al registrar SW:', err));
    }
    
    // 8. CONECTAR EL BOT√ìN DE NOTIFICACIONES (Sin cambios)
    const botonNotificaciones = document.getElementById('activar-notificaciones');
    if (botonNotificaciones) {
        botonNotificaciones.addEventListener('click', obtenerYMostrarToken);
    }

    // -----------------------------------------------------------------
    // 9. ¬°NUEVA L√ìGICA DE INSTALACI√ìN DE PWA!
    // -----------------------------------------------------------------
    
    let deferredPrompt; // Variable para guardar el evento
    const installButton = document.getElementById('install-pwa-button');
    const installLoader = document.getElementById('install-loader-overlay');
    const successModal = document.getElementById('install-success-overlay');
    const closeSuccessButton = document.getElementById('close-success-modal');

    // A. CAPTURAR EL EVENTO DE "LISTO PARA INSTALAR"
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevenir que el navegador muestre su mini-banner
      e.preventDefault();
      // Guardar el evento para usarlo despu√©s
      deferredPrompt = e;
      // Mostrar NUESTRO bot√≥n de instalar
      console.log('La app est√° lista para ser instalada.');
      installButton.style.display = 'block';
    });

    // B. L√ìGICA DEL BOT√ìN DE INSTALAR
    installButton.addEventListener('click', async () => {
      // Ocultar el bot√≥n (ya no lo necesitamos)
      installButton.style.display = 'none';
      
      // Mostrar el prompt de instalaci√≥n nativo del navegador
      deferredPrompt.prompt();
      
      // Esperar a que el usuario elija (Aceptar o Cancelar)
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('El usuario acept√≥ la instalaci√≥n.');
        // ¬°MOSTRAR EL MENSAJE DE "INSTALANDO..."!
        installLoader.style.display = 'flex';
      } else {
        console.log('El usuario cancel√≥ la instalaci√≥n.');
        // Volver a mostrar el bot√≥n por si cambia de opini√≥n
        installButton.style.display = 'block';
      }
      deferredPrompt = null; // El evento solo se usa una vez
    });

    // C. L√ìGICA DE "INSTALACI√ìN COMPLETA"
    window.addEventListener('appinstalled', (event) => {
      console.log('‚úÖ PWA instalada correctamente.');
      
      // Ocultar el loader de "Instalando..."
      installLoader.style.display = 'none';
      
      // ¬°MOSTRAR EL MENSAJE DE "INSTALACI√ìN COMPLETA"!
      successModal.style.display = 'flex';
      
      // Pedir permiso de notificaciones (como quer√≠as)
      obtenerYMostrarToken();
    });

    // D. L√ìGICA PARA CERRAR EL MODAL DE √âXITO
    closeSuccessButton.addEventListener('click', () => {
      successModal.style.display = 'none';
    });

  </script>
</body>
</html>

